<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart DOCX Template Filler</title>
  <meta name="description" content="Auto-detect placeholders in DOCX, generate form, and export filled DOCX. Bilingual English/Hindi UI." />
  <style>
    :root {
      --bg: #0b1020;
      --panel: #11182a;
      --muted: #6b7280;
      --text: #e5e7eb;
      --accent: #7c3aed;
      --accent-2: #06b6d4;
      --danger: #ef4444;
      --ok: #22c55e;
      --border: #1f2937;
      --chip: #1b243b;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
      Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background: radial-gradient(1200px 600px at 80% -10%, #1e293b 0%, #0b1020 40%), var(--bg);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display: flex; gap: 16px; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3), inset 0 0 20px rgba(255,255,255,0.15);
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .subtle { color: var(--muted); font-size: 14px; }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent 60%), var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px; padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 16px; }

    h2 { margin: 0 0 10px; font-size: 18px; }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .spacer { height: 10px; }

    input[type="file"], select, input[type="text"], input[type="date"], input[type="number"], textarea {
      width: 100%; box-sizing: border-box;
      background: #0e1525; color: var(--text);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 12px; outline: none;
    }
    textarea { min-height: 86px; resize: vertical; }

    .btn {
      background: #10182b; color: var(--text);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 14px; cursor: pointer; transition: .15s ease;
    }
    .btn:hover { border-color: #334155; transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; }
    .btn.danger { background: #20121a; border: 1px solid #3b0e19; color: #fecaca; }
    .btn.ok { background: #0c1a13; border: 1px solid #164e3f; color: #bbf7d0; }

    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { background: var(--chip); border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; font-size: 12px; color: #a6adbb; }

    .placeholder-list { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }

    .footer { color: var(--muted); font-size: 12px; text-align: center; padding: 18px 0; }

    .kbd { border: 1px solid var(--border); border-bottom-width: 3px; background: #0c1322; padding: 4px 8px; border-radius: 6px; font-size: 12px; color: #a6adbb; }

    .hidden { display: none; }

    .lang-toggle { background: #0e1525; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: inline-flex; }
    .lang-toggle button { padding: 8px 10px; border: none; background: transparent; color: var(--text); cursor: pointer; }
    .lang-toggle button.active { background: #111a30; color: #e0e7ff; }

    .notice { font-size: 13px; color: #a6adbb; }
    .error { color: #fecaca; background: #2a0e14; border: 1px solid #3b0e19; padding: 10px; border-radius: 10px; }
  </style>
  <!-- Dependencies (Browser builds) -->
  <script src="https://unpkg.com/pizzip@3.1.7/dist/pizzip.js"></script>
  <script src="https://unpkg.com/pizzip@3.1.7/dist/pizzip-utils.js"></script>
  <script src="https://unpkg.com/docxtemplater@3.38.0/build/docxtemplater.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Smart DOCX Template Filler</div>
          <div class="subtle" data-i18n="subtitle">Auto-detect placeholders ? Form generation ? Offline template storage</div>
        </div>
      </div>
      <div class="row">
        <div class="lang-toggle" role="tablist" aria-label="Language">
          <button id="lang-en" class="active" aria-selected="true">English</button>
          <button id="lang-hi" aria-selected="false">?????</button>
        </div>
      </div>
    </header>

    <div class="spacer"></div>

    <section class="panel">
      <div class="row" style="justify-content: space-between; align-items: start; gap: 14px;">
        <div style="flex:1; min-width: 280px;">
          <h2 data-i18n="templateHeader">Template</h2>
          <div class="notice" data-i18n="templateNote">Use a .docx template containing placeholders like {{Name}} or &lt;Name&gt;.</div>
        </div>
        <div class="row" style="gap: 8px;">
          <button id="btn-replace-template" class="btn" type="button" data-i18n="replaceTemplate">Replace Template</button>
          <button id="btn-clear-template" class="btn danger" type="button" data-i18n="clearTemplate">Clear Stored Template</button>
        </div>
      </div>
      <div class="spacer"></div>
      <input id="file-input" class="hidden" type="file" accept=".docx" />

      <div id="template-info" class="chips"></div>
      <div id="template-error" class="error hidden"></div>
    </section>

    <div class="spacer"></div>

    <section class="panel">
      <h2 data-i18n="placeholdersHeader">Detected Placeholders</h2>
      <div id="placeholders-empty" class="notice" data-i18n="noPlaceholders">No placeholders detected yet.</div>
      <div id="placeholder-list" class="placeholder-list"></div>
    </section>

    <div class="spacer"></div>

    <section class="panel">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h2 data-i18n="formHeader">Auto-Generated Form</h2>
        <div class="row" style="gap: 8px;">
          <button id="btn-save-answers" class="btn" type="button" data-i18n="saveAnswers">Save Answers</button>
          <button id="btn-load-answers" class="btn" type="button" data-i18n="loadAnswers">Load Answers</button>
          <button id="btn-clear-answers" class="btn danger" type="button" data-i18n="clearAnswers">Clear Answers</button>
        </div>
      </div>
      <div class="spacer"></div>
      <form id="dynamic-form"></form>
      <div class="spacer"></div>
      <div class="row" style="gap: 10px;">
        <button id="btn-download" class="btn primary" type="button" data-i18n="downloadDocx">Download DOCX</button>
        <span class="notice" data-i18n="downloadHint">Keeps exact formatting of the template</span>
      </div>
    </section>

    <div class="footer">
      <span data-i18n="foot1">Tip: Press</span> <span class="kbd">Ctrl</span> + <span class="kbd">S</span> <span data-i18n="foot2">to save answers quickly.</span>
    </div>
  </div>

<script>
(function(){
  const i18n = {
    en: {
      subtitle: "Auto-detect placeholders ? Form generation ? Offline template storage",
      templateHeader: "Template",
      templateNote: "Use a .docx template containing placeholders like {{Name}} or <Name>.",
      replaceTemplate: "Replace Template",
      clearTemplate: "Clear Stored Template",
      placeholdersHeader: "Detected Placeholders",
      noPlaceholders: "No placeholders detected yet.",
      formHeader: "Auto-Generated Form",
      saveAnswers: "Save Answers",
      loadAnswers: "Load Answers",
      clearAnswers: "Clear Answers",
      downloadDocx: "Download DOCX",
      downloadHint: "Keeps exact formatting of the template",
      foot1: "Tip: Press",
      foot2: "to save answers quickly.",
    },
    hi: {
      subtitle: "??????????? ???????? ????? ? ????? ?????? ? ??????? ???????? ??????",
      templateHeader: "????????",
      templateNote: "??? .docx ???????? ?? ????? ???? ?????? {{Name}} ?? <Name> ???? ??????????? ????",
      replaceTemplate: "???????? ?????",
      clearTemplate: "???????? ???????? ?????",
      placeholdersHeader: "??? ???? ?? ???????????",
      noPlaceholders: "??? ??? ??????????? ???? ?????",
      formHeader: "????? ??????? ?????",
      saveAnswers: "????? ??????",
      loadAnswers: "????? ??? ????",
      clearAnswers: "????? ?????",
      downloadDocx: "DOCX ??????? ????",
      downloadHint: "???????? ?? ???? ???????? ???? ???? ??",
      foot1: "??????: ????? ?????? ?? ???",
      foot2: "??????",
    }
  };

  const els = {
    langEn: document.getElementById('lang-en'),
    langHi: document.getElementById('lang-hi'),
    fileInput: document.getElementById('file-input'),
    btnReplaceTemplate: document.getElementById('btn-replace-template'),
    btnClearTemplate: document.getElementById('btn-clear-template'),
    templateInfo: document.getElementById('template-info'),
    templateError: document.getElementById('template-error'),
    placeholdersEmpty: document.getElementById('placeholders-empty'),
    placeholderList: document.getElementById('placeholder-list'),
    form: document.getElementById('dynamic-form'),
    btnSaveAnswers: document.getElementById('btn-save-answers'),
    btnLoadAnswers: document.getElementById('btn-load-answers'),
    btnClearAnswers: document.getElementById('btn-clear-answers'),
    btnDownload: document.getElementById('btn-download'),
  };

  const STORAGE_KEYS = {
    template: 'docx_template_base64_v1',
    answers: 'docx_answers_v1',
    delimiter: 'docx_delimiter_v1',
    placeholderOrder: 'docx_placeholder_order_v1',
    lang: 'ui_lang_v1',
  };

  let state = {
    lang: localStorage.getItem(STORAGE_KEYS.lang) || 'en',
    templateBase64: localStorage.getItem(STORAGE_KEYS.template) || null,
    delimiter: localStorage.getItem(STORAGE_KEYS.delimiter) || '{{}}',
    placeholders: [],
    answers: {},
  };

  function applyI18n() {
    const dict = i18n[state.lang];
    document.querySelectorAll('[data-i18n]').forEach(node => {
      const key = node.getAttribute('data-i18n');
      if (dict[key]) node.textContent = dict[key];
    });
    els.langEn.classList.toggle('active', state.lang === 'en');
    els.langHi.classList.toggle('active', state.lang === 'hi');
    els.langEn.setAttribute('aria-selected', state.lang === 'en');
    els.langHi.setAttribute('aria-selected', state.lang === 'hi');
    document.documentElement.lang = state.lang === 'hi' ? 'hi' : 'en';
  }

  function toBase64FromArrayBuffer(ab) {
    const bytes = new Uint8Array(ab);
    let binary = '';
    const chunk = 0x8000;
    for (let i = 0; i < bytes.length; i += chunk) {
      binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
    }
    return btoa(binary);
  }

  function arrayBufferFromBase64(base64) {
    const binary = atob(base64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
  }

  function friendlyLabel(key) {
    return key
      .replace(/[_-]+/g, ' ')
      .replace(/([a-z])([A-Z])/g, '$1 $2')
      .replace(/\s+/g, ' ')
      .trim()
      .replace(/^\w/, c => c.toUpperCase());
  }

  function inferType(key) {
    const k = key.toLowerCase();
    if (/(date|dob|incident|reported)_?/.test(k)) return 'date';
    if (/(email|e-mail)/.test(k)) return 'email';
    if (/(phone|mobile|contact|fir_no|number|id|count|qty)/.test(k)) return 'text';
    if (/(address|details|description|summary|remarks|notes|statement)/.test(k)) return 'textarea';
    return 'text';
  }

  function renderTemplateInfo(sizeBytes, delimiter) {
    els.templateInfo.innerHTML = '';
    const sizeKb = Math.round((sizeBytes / 1024) * 10) / 10;
    const chips = [
      { label: 'DOCX', value: 'Template' },
      { label: 'Size', value: `${sizeKb} KB` },
      { label: 'Delimiters', value: delimiter === '<>' ? '<?>' : '{{?}}' },
      { label: 'Placeholders', value: String(state.placeholders.length) },
    ];
    chips.forEach(c => {
      const el = document.createElement('div');
      el.className = 'chip';
      el.textContent = `${c.label}: ${c.value}`;
      els.templateInfo.appendChild(el);
    });
  }

  function setError(msg) {
    els.templateError.textContent = msg || '';
    els.templateError.classList.toggle('hidden', !msg);
  }

  function extractPlaceholdersFromDocx(base64) {
    // Try both {{ }} and < > delimiters, prefer the one yielding more tags
    const ab = arrayBufferFromBase64(base64);
    const content = new Uint8Array(ab);

    function tryExtract(delims) {
      try {
        const zip = new PizZip(content);
        const doc = new window.docxtemplater(zip, {
          paragraphLoop: true,
          linebreaks: true,
          delimiters: delims || undefined,
        });
        const tagsObj = doc.getTags ? doc.getTags() : {};
        const tags = Object.keys(tagsObj || {});
        return { tags, delims };
      } catch (e) {
        return { tags: [], delims };
      }
    }

    const resCurly = tryExtract({ start: '{{', end: '}}' });
    const resAngle = tryExtract({ start: '<', end: '>' });

    const chosen = resAngle.tags.length > resCurly.tags.length ? resAngle : resCurly;
    const placeholders = chosen.tags.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
    return { placeholders, delimiter: chosen.delims.start === '<' ? '<>' : '{{}}' };
  }

  function renderPlaceholderList(keys) {
    els.placeholderList.innerHTML = '';
    els.placeholdersEmpty.classList.toggle('hidden', keys.length > 0);
    keys.forEach(k => {
      const el = document.createElement('div');
      el.className = 'chip';
      el.textContent = k;
      els.placeholderList.appendChild(el);
    });
  }

  function renderForm(keys) {
    els.form.innerHTML = '';
    const order = JSON.parse(localStorage.getItem(STORAGE_KEYS.placeholderOrder) || '[]');
    const used = new Set(order);
    const finalKeys = [...order.filter(k => keys.includes(k)), ...keys.filter(k => !used.has(k))];

    finalKeys.forEach(key => {
      const wrap = document.createElement('div');
      wrap.style.marginBottom = '12px';

      const label = document.createElement('label');
      label.textContent = friendlyLabel(key);
      label.style.display = 'block';
      label.style.marginBottom = '6px';

      const type = inferType(key);
      let input;
      if (type === 'textarea') {
        input = document.createElement('textarea');
      } else {
        input = document.createElement('input');
        input.type = type === 'email' ? 'email' : (type === 'date' ? 'date' : 'text');
      }
      input.name = key;
      input.value = state.answers[key] || '';

      wrap.appendChild(label);
      wrap.appendChild(input);
      els.form.appendChild(wrap);
    });
  }

  function saveAnswers() {
    const data = {};
    Array.from(els.form.elements).forEach(el => {
      if (!el.name) return;
      data[el.name] = el.value;
    });
    state.answers = data;
    localStorage.setItem(STORAGE_KEYS.answers, JSON.stringify(data));
  }

  function loadAnswers() {
    try {
      const raw = localStorage.getItem(STORAGE_KEYS.answers);
      if (!raw) return;
      const data = JSON.parse(raw);
      state.answers = data || {};
      // update form
      Array.from(els.form.elements).forEach(el => {
        if (el.name && data[el.name] != null) el.value = data[el.name];
      });
    } catch {}
  }

  function clearAnswers() {
    localStorage.removeItem(STORAGE_KEYS.answers);
    state.answers = {};
    Array.from(els.form.elements).forEach(el => { if (el.name) el.value = ''; });
  }

  function persistTemplate(base64, delimiter, placeholders) {
    localStorage.setItem(STORAGE_KEYS.template, base64);
    localStorage.setItem(STORAGE_KEYS.delimiter, delimiter);
    localStorage.setItem(STORAGE_KEYS.placeholderOrder, JSON.stringify(placeholders));
  }

  function setTemplate(base64) {
    setError('');
    try {
      const { placeholders, delimiter } = extractPlaceholdersFromDocx(base64);
      state.templateBase64 = base64;
      state.delimiter = delimiter;
      state.placeholders = placeholders;
      renderPlaceholderList(placeholders);
      renderForm(placeholders);
      const sizeBytes = arrayBufferFromBase64(base64).byteLength;
      renderTemplateInfo(sizeBytes, delimiter);
      persistTemplate(base64, delimiter, placeholders);
    } catch (e) {
      console.error(e);
      setError('Failed to parse template. Ensure it is a valid .docx with placeholders.');
    }
  }

  function generateDocxAndDownload() {
    if (!state.templateBase64) {
      setError('Please add a .docx template first.');
      return;
    }
    try {
      const ab = arrayBufferFromBase64(state.templateBase64);
      const content = new Uint8Array(ab);
      const zip = new PizZip(content);
      const delims = state.delimiter === '<>' ? { start: '<', end: '>' } : { start: '{{', end: '}}' };
      const doc = new window.docxtemplater(zip, {
        paragraphLoop: true,
        linebreaks: true,
        delimiters: delims,
      });

      // collect latest answers from form
      saveAnswers();
      doc.setData(state.answers);
      doc.render();

      const out = doc.getZip().generate({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
      const url = URL.createObjectURL(out);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'filled.docx';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
    } catch (e) {
      console.error(e);
      const msg = (e && e.properties && e.properties.errors) ? e.properties.errors.map(er => er.properties.explanation).join('\n') : (e.message || 'Unknown error');
      setError('Failed to generate DOCX: ' + msg);
    }
  }

  // Wire events
  els.btnReplaceTemplate.addEventListener('click', () => {
    els.fileInput.click();
  });
  els.fileInput.addEventListener('change', async (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    const ab = await file.arrayBuffer();
    const base64 = toBase64FromArrayBuffer(ab);
    setTemplate(base64);
    ev.target.value = '';
  });
  els.btnClearTemplate.addEventListener('click', () => {
    localStorage.removeItem(STORAGE_KEYS.template);
    localStorage.removeItem(STORAGE_KEYS.delimiter);
    localStorage.removeItem(STORAGE_KEYS.placeholderOrder);
    state.templateBase64 = null;
    state.placeholders = [];
    state.delimiter = '{{}}';
    renderPlaceholderList([]);
    renderForm([]);
    els.templateInfo.innerHTML = '';
  });

  els.btnSaveAnswers.addEventListener('click', saveAnswers);
  els.btnLoadAnswers.addEventListener('click', loadAnswers);
  els.btnClearAnswers.addEventListener('click', clearAnswers);
  els.btnDownload.addEventListener('click', generateDocxAndDownload);

  // Language toggle
  function setLang(lang) {
    state.lang = lang;
    localStorage.setItem(STORAGE_KEYS.lang, lang);
    applyI18n();
  }
  els.langEn.addEventListener('click', () => setLang('en'));
  els.langHi.addEventListener('click', () => setLang('hi'));

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      saveAnswers();
      const saved = document.createElement('div');
      saved.className = 'chip';
      saved.textContent = 'Saved';
      els.templateInfo.appendChild(saved);
      setTimeout(() => saved.remove(), 1500);
    }
  });

  // Init
  applyI18n();
  if (state.templateBase64) {
    try {
      const { placeholders, delimiter } = extractPlaceholdersFromDocx(state.templateBase64);
      state.placeholders = placeholders;
      state.delimiter = delimiter;
      renderPlaceholderList(placeholders);
      renderForm(placeholders);
      const sizeBytes = arrayBufferFromBase64(state.templateBase64).byteLength;
      renderTemplateInfo(sizeBytes, delimiter);
    } catch (e) {
      console.warn('Stored template failed to parse; clearing.');
      localStorage.removeItem(STORAGE_KEYS.template);
    }
  }
  loadAnswers();
})();
</script>
</body>
</html>
